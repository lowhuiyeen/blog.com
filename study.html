<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å­¦ä¹  Study</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="stylesheet" href="assets/style.css" />
  <script src="assets/password.js" defer></script>
</head>
<body>
  <div id="header-placeholder"></div>

  <!-- Modal -->
  <div id="pw-overlay" class="modal-overlay hidden" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å†…å®¹</h3>
      <div>
        <input id="pw-input" type="password" placeholder="å¯†ç " autocomplete="off" />
        <div id="pw-hint" class="error" aria-live="polite"></div>
      </div>
      <div class="row">
        <button id="pw-btn">è¿›å…¥</button>
      </div>
    </div>
  </div>

  <!-- Mask placeholder -->
  <div id="mask" class="container">
    <div class="card"><p>æ­£åœ¨ç­‰å¾…å¯†ç éªŒè¯â€¦</p></div>
  </div>

  <main class="container">
    <!-- Card list -->
    <section id="note-list" class="card-grid">
      <!-- Example card (auto-filled by JS if you want multiple) -->
      <article class="card note-card" data-note="content/CMEP.md" tabindex="0" aria-label="CMEP Note">
        <h2>ğŸ“˜ CMEP Notes</h2>
        <p class="note-snippet">Introduction to the Malaysian Capital Market, components, GDP links, and CMP3â€¦</p>
        <div class="row">
          <button class="btn read-btn" data-note="content/CMEP.md">Read</button>
        </div>
      </article>
    </section>

    <!-- Fullscreen Reader (Modal) -->
    <div id="reader-overlay" class="modal-overlay hidden" aria-modal="true" role="dialog" aria-labelledby="reader-title">
      <div class="modal modal-reader" role="document">
        <header class="reader-header">
          <h3 id="reader-title">Reader</h3>
          <div class="reader-actions">
            <a id="open-raw" class="btn link" href="#" target="_blank" rel="noopener">Open Raw</a>
            <button id="print-reader" class="btn">Print</button>
            <button id="close-reader" class="btn btn-ghost" aria-label="Close (Esc)">âœ•</button>
          </div>
        </header>
        <div id="reader-content" class="reader-body" tabindex="0" aria-live="polite">
          <p>Loadingâ€¦</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer" id="footer-placeholder"></footer>

  <script>
    async function loadPartials() {
      try {
        const [header, footer] = await Promise.all([
          fetch('partials/header.html').then(r => r.text()),
          fetch('partials/footer.html').then(r => r.text())
        ]);
        document.getElementById('header-placeholder').innerHTML = header;
        document.getElementById('footer-placeholder').innerHTML = footer;
      } catch (e) {
        console.error('Failed to load partials', e);
      }
    }
    document.addEventListener('DOMContentLoaded', loadPartials);
  </script>

  <!-- Markdown renderer + sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

  <script>
    // Utility: fetch & render MD
    async function fetchMarkdown(src) {
      const res = await fetch(src, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Failed to fetch ${src} (${res.status})`);
      return res.text();
    }

    function renderMDInto(htmlContainer, mdText) {
      const html = DOMPurify.sanitize(marked.parse(mdText));
      htmlContainer.innerHTML = html;
    }

    // Reader controls
    const overlay = document.getElementById('reader-overlay');
    const readerContent = document.getElementById('reader-content');
    const closeBtn = document.getElementById('close-reader');
    const printBtn = document.getElementById('print-reader');
    const openRaw = document.getElementById('open-raw');

    let lastFocused = null;

    async function openReader(src, title = 'Reader') {
      // remember focus
      lastFocused = document.activeElement;

      // header title / raw link
      document.getElementById('reader-title').textContent = title;
      openRaw.href = src;

      // load content
      readerContent.innerHTML = '<p>Loadingâ€¦</p>';
      try {
        const md = await fetchMarkdown(src);
        renderMDInto(readerContent, md);
        // focus body for keyboard scroll
        setTimeout(() => readerContent.focus(), 0);
      } catch (e) {
        readerContent.innerHTML = `<p class="error">æ— æ³•åŠ è½½å†…å®¹ï¼š${e.message}</p>`;
      }

      // show modal
      overlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // lock background scroll
    }

    function closeReader() {
      overlay.classList.add('hidden');
      document.body.style.overflow = '';
      if (lastFocused) lastFocused.focus();
    }

    // Click handlers for cards & buttons
    function wireNoteCards() {
      document.querySelectorAll('.read-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const src = btn.getAttribute('data-note');
          const card = btn.closest('.note-card');
          const title = card?.querySelector('h2')?.textContent?.trim() || 'Reader';
          openReader(src, title);
        });
      });

      // also allow Enter on whole card
      document.querySelectorAll('.note-card').forEach(card => {
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const src = card.getAttribute('data-note');
            const title = card.querySelector('h2')?.textContent?.trim() || 'Reader';
            openReader(src, title);
          }
        });
      });
    }

    // Close / Esc / overlay click
    closeBtn.addEventListener('click', closeReader);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeReader();
    });
    window.addEventListener('keydown', (e) => {
      if (!overlay.classList.contains('hidden') && e.key === 'Escape') closeReader();
    });

    // Print
    printBtn.addEventListener('click', () => {
      // print only modal content
      const win = window.open('', '_blank');
      win.document.write(`
        <html><head><title>Print</title>
        <style>
          body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
          img { max-width: 100%; border:2px solid #ccc; border-radius:8px; }
          pre { background:#f7f7f7; padding:12px; border-radius:10px; overflow:auto; }
          blockquote { border-left: 4px solid #ddd; padding-left:12px; color:#555; }
        </style>
        </head><body>${readerContent.innerHTML}</body></html>
      `);
      win.document.close();
      win.focus();
      win.print();
      win.close();
    });

    // Integrate with your password flow
    window.onPasswordGranted = function () {
      document.getElementById('pw-overlay').classList.add('hidden');
      document.getElementById('mask').classList.add('hidden');
      document.getElementById('content')?.classList?.remove('hidden'); // if you keep it
      wireNoteCards();
    };

    // Auto-enable for local preview when overlay hidden by default
    document.addEventListener('DOMContentLoaded', () => {
      const pw = document.getElementById('pw-overlay');
      if (pw && pw.classList.contains('hidden')) {
        window.onPasswordGranted();
      }
    });
  </script>


</body>
</html>
